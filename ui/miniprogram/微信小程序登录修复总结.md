# å¾®ä¿¡å°ç¨‹åºç™»å½•ä¿®å¤æ€»ç»“

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆå¾®ä¿¡å°ç¨‹åºç™»å½•åŠŸèƒ½ä¸å·¥ä½œï¼Œå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š
```
{"code":401,"message":"å¾®ä¿¡æˆæƒå¤±è´¥: è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥: å¾®ä¿¡APIé”™è¯¯: 40242 - invalid oauth code, it is miniprogram jscode, please use jscode2session"}
```

## ğŸ” é—®é¢˜åˆ†æ

### 1. é”™è¯¯åŸå› 
- **é”™è¯¯ç 40242**: è¡¨ç¤ºä½¿ç”¨äº†é”™è¯¯çš„APIæ¥å£
- **é”™è¯¯ä¿¡æ¯**: "invalid oauth code, it is miniprogram jscode, please use jscode2session"
- **æ ¹æœ¬åŸå› **: å‰ç«¯ä»£ç è°ƒç”¨äº†`/auth/wechat/callback`æ¥å£ï¼Œä½†è¯¥æ¥å£æ˜¯ä¸ºå¾®ä¿¡ç½‘é¡µæˆæƒè®¾è®¡çš„ï¼Œä¸é€‚ç”¨äºå°ç¨‹åºç™»å½•

### 2. æŠ€æœ¯èƒŒæ™¯
- **å¾®ä¿¡ç½‘é¡µæˆæƒ**: ä½¿ç”¨`/sns/oauth2/access_token`æ¥å£
- **å¾®ä¿¡å°ç¨‹åºç™»å½•**: ä½¿ç”¨`/sns/jscode2session`æ¥å£
- **åŒºåˆ«**: å°ç¨‹åºç™»å½•æ— æ³•è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯ï¼Œåªèƒ½è·å–openidå’Œsession_key

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### 1. åç«¯ä¿®å¤

#### 1.1 æ·»åŠ å°ç¨‹åºç™»å½•æœåŠ¡æ–¹æ³•
**æ–‡ä»¶**: `internal/services/wechat_auth_service.go`

```go
// HandleMiniProgramLogin å¤„ç†å¾®ä¿¡å°ç¨‹åºç™»å½•
func (s *WeChatAuthService) HandleMiniProgramLogin(ctx context.Context, code, tenantID string) (*WeChatUserInfo, error) {
    // ä½¿ç”¨jscode2sessionè·å–openidå’Œsession_key
    sessionInfo, err := s.getMiniProgramSession(ctx, code, appID, appSecret)
    if err != nil {
        return nil, fmt.Errorf("è·å–å°ç¨‹åºä¼šè¯å¤±è´¥: %w", err)
    }

    // æ„é€ ç”¨æˆ·ä¿¡æ¯ï¼ˆå°ç¨‹åºç™»å½•æ— æ³•è·å–è¯¦ç»†ç”¨æˆ·ä¿¡æ¯ï¼‰
    userInfo := &WeChatUserInfo{
        OpenID:   sessionInfo.OpenID,
        UnionID:  sessionInfo.UnionID,
        Nickname: "å¾®ä¿¡ç”¨æˆ·", // é»˜è®¤æ˜µç§°
        Avatar:   "",        // æ— æ³•è·å–å¤´åƒ
        Gender:   0,         // æœªçŸ¥æ€§åˆ«
    }

    return userInfo, nil
}

// getMiniProgramSession è·å–å¾®ä¿¡å°ç¨‹åºä¼šè¯ä¿¡æ¯
func (s *WeChatAuthService) getMiniProgramSession(ctx context.Context, code, appID, appSecret string) (*WeChatMiniProgramSessionResponse, error) {
    // è°ƒç”¨å¾®ä¿¡jscode2sessionæ¥å£
    sessionURL := fmt.Sprintf("https://api.weixin.qq.com/sns/jscode2session?%s", params.Encode())
    // ... å®ç°è¯¦æƒ…
}
```

#### 1.2 æ·»åŠ å°ç¨‹åºç™»å½•æ§åˆ¶å™¨
**æ–‡ä»¶**: `internal/api/controllers/wechat_auth_controller.go`

```go
// HandleMiniProgramLogin å¤„ç†å¾®ä¿¡å°ç¨‹åºç™»å½•
func (c *WeChatAuthController) HandleMiniProgramLogin(ctx *gin.Context) {
    code := ctx.Query("code")
    
    // å¤„ç†å¾®ä¿¡å°ç¨‹åºç™»å½•
    wechatUserInfo, err := c.wechatService.HandleMiniProgramLogin(ctx.Request.Context(), code, tenantID)
    
    // æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
    user, isNewUser, err := c.findOrCreateUser(ctx, wechatUserInfo, tenantID)
    
    // ç”ŸæˆJWTä»¤ç‰Œ
    tokenResponse, err := services.GenerateTokenPair(c.jwtService, user.ID, user.Username)
    
    // è¿”å›å“åº”
    response := WeChatLoginResponse{
        Tokens: &TokenInfo{
            AccessToken:  tokenResponse.AccessToken,
            RefreshToken: tokenResponse.RefreshToken,
            ExpiresIn:    tokenResponse.ExpiresIn,
        },
        User:       user,
        IsNewUser:  isNewUser,
        WeChatInfo: wechatUserInfo,
    }
}
```

#### 1.3 æ³¨å†Œæ–°è·¯ç”±
**æ–‡ä»¶**: `internal/api/router/api/wechat_auth.go`

```go
func RegisterWeChatAuthRoutes(r *gin.RouterGroup) {
    wechatGroup := r.Group("/auth/wechat")
    {
        wechatGroup.GET("/auth", wechatAuthController.GetAuthURL)           // ç½‘é¡µæˆæƒ
        wechatGroup.GET("/callback", wechatAuthController.HandleCallback)   // ç½‘é¡µå›è°ƒ
        wechatGroup.GET("/jscode2session", wechatAuthController.HandleMiniProgramLogin) // å°ç¨‹åºç™»å½•
    }
}
```

#### 1.4 ä¿®å¤å“åº”æ•°æ®ç»“æ„
**é—®é¢˜**: å‰ç«¯æœŸæœ›`response.tokens`å¯¹è±¡ï¼Œåç«¯è¿”å›ç‹¬ç«‹å­—æ®µ
**è§£å†³æ–¹æ¡ˆ**: å°†tokenç›¸å…³å­—æ®µåŒ…è£…åœ¨`tokens`å¯¹è±¡ä¸­

```go
// ä¿®å¤å‰
type WeChatLoginResponse struct {
    Token        string `json:"token"`
    RefreshToken string `json:"refresh_token"`
    ExpiresIn    int64  `json:"expires_in"`
    User         *models.User `json:"user"`
}

// ä¿®å¤å
type WeChatLoginResponse struct {
    Tokens      *TokenInfo `json:"tokens"`
    User        *models.User `json:"user"`
}

type TokenInfo struct {
    AccessToken  string `json:"access_token"`
    RefreshToken string `json:"refresh_token"`
    ExpiresIn    int64  `json:"expires_in"`
}
```

### 2. å‰ç«¯ä¿®å¤

#### 2.1 ä¿®æ”¹APIæ¥å£è·¯å¾„
**æ–‡ä»¶**: `ui/miniprogram/pages/auth/login/login.js` å’Œ `ui/miniprogram/pages/index/index.js`

```javascript
// ä¿®å¤å‰
const response = await get('/auth/wechat/callback', {
  code: loginRes.code
})

// ä¿®å¤å
const response = await get('/auth/wechat/jscode2session', {
  code: loginRes.code
})
```

#### 2.2 ç¡®ä¿å“åº”æ•°æ®ç»“æ„åŒ¹é…
å‰ç«¯ä»£ç å·²ç»æ­£ç¡®æœŸæœ›`response.tokens`ç»“æ„ï¼š

```javascript
if (response.user && response.tokens) {
  // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
  app.setUserInfo(response.user, response.tokens.access_token)
  
  // ä¿å­˜tokenåˆ°æœ¬åœ°å­˜å‚¨
  wx.setStorageSync('token', response.tokens.access_token)
  wx.setStorageSync('refresh_token', response.tokens.refresh_token)
  wx.setStorageSync('user_info', response.user)
}
```

## ğŸ“‹ ä¿®å¤æ¸…å•

### âœ… åç«¯ä¿®å¤
- [x] æ·»åŠ `HandleMiniProgramLogin`æœåŠ¡æ–¹æ³•
- [x] æ·»åŠ `getMiniProgramSession`æ–¹æ³•
- [x] æ·»åŠ `HandleMiniProgramLogin`æ§åˆ¶å™¨æ–¹æ³•
- [x] æ³¨å†Œ`/auth/wechat/jscode2session`è·¯ç”±
- [x] ä¿®å¤å“åº”æ•°æ®ç»“æ„ï¼ˆåŒ…è£…tokenså¯¹è±¡ï¼‰
- [x] æ·»åŠ `WeChatMiniProgramSessionResponse`ç»“æ„ä½“
- [x] æ·»åŠ `TokenInfo`ç»“æ„ä½“

### âœ… å‰ç«¯ä¿®å¤
- [x] ä¿®æ”¹ç™»å½•é¡µAPIæ¥å£è·¯å¾„
- [x] ä¿®æ”¹é¦–é¡µAPIæ¥å£è·¯å¾„
- [x] ç¡®ä¿å“åº”æ•°æ®ç»“æ„åŒ¹é…
- [x] å®Œå–„é”™è¯¯å¤„ç†

## ğŸ”„ ç™»å½•æµç¨‹

### 1. å°ç¨‹åºç«¯æµç¨‹
```javascript
// 1. è·å–å¾®ä¿¡ç™»å½•code
const loginRes = await wx.login()

// 2. è°ƒç”¨åç«¯jscode2sessionæ¥å£
const response = await get('/auth/wechat/jscode2session', {
  code: loginRes.code
})

// 3. ä¿å­˜ç”¨æˆ·ä¿¡æ¯å’Œtoken
if (response.user && response.tokens) {
  app.setUserInfo(response.user, response.tokens.access_token)
  wx.setStorageSync('token', response.tokens.access_token)
  wx.setStorageSync('user_info', response.user)
}
```

### 2. åç«¯å¤„ç†æµç¨‹
```go
// 1. æ¥æ”¶å°ç¨‹åºç™»å½•code
code := ctx.Query("code")

// 2. è°ƒç”¨å¾®ä¿¡jscode2sessionæ¥å£
sessionInfo, err := s.getMiniProgramSession(ctx, code, appID, appSecret)

// 3. æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
user, isNewUser, err := c.findOrCreateUser(ctx, wechatUserInfo, tenantID)

// 4. ç”ŸæˆJWTä»¤ç‰Œ
tokenResponse, err := services.GenerateTokenPair(c.jwtService, user.ID, user.Username)

// 5. è¿”å›å“åº”
response := WeChatLoginResponse{
    Tokens: &TokenInfo{...},
    User: user,
    WeChatInfo: wechatUserInfo,
}
```

## ğŸ¯ ç”¨æˆ·æ•°æ®å­˜å‚¨

### 1. ç”¨æˆ·è¡¨å­—æ®µ
- **username**: `wechat_` + `openid`ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
- **password**: `wechat_user_` + `openid`ï¼ˆç‰¹æ®Šå¯†ç ï¼‰
- **nickname**: å¾®ä¿¡ç”¨æˆ·ï¼ˆé»˜è®¤å€¼ï¼‰
- **avatar**: ç©ºï¼ˆå°ç¨‹åºç™»å½•æ— æ³•è·å–ï¼‰

### 2. å¾®ä¿¡ä¿¡æ¯å­˜å‚¨
- **openid**: å­˜å‚¨åœ¨ç”¨æˆ·usernameä¸­
- **unionid**: å­˜å‚¨åœ¨WeChatUserInfoä¸­
- **session_key**: ä»…ç”¨äºç™»å½•éªŒè¯ï¼Œä¸å­˜å‚¨

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. åŠŸèƒ½æµ‹è¯•
- [ ] æµ‹è¯•å°ç¨‹åºå¾®ä¿¡ç™»å½•æµç¨‹
- [ ] éªŒè¯ç”¨æˆ·ä¿¡æ¯æ­£ç¡®ä¿å­˜
- [ ] éªŒè¯tokenæ­£ç¡®ç”Ÿæˆå’Œå­˜å‚¨
- [ ] æµ‹è¯•ç™»å½•çŠ¶æ€æŒä¹…åŒ–

### 2. é”™è¯¯æµ‹è¯•
- [ ] æµ‹è¯•æ— æ•ˆcodeçš„å¤„ç†
- [ ] æµ‹è¯•ç½‘ç»œé”™è¯¯çš„å¤„ç†
- [ ] æµ‹è¯•å¾®ä¿¡APIé”™è¯¯çš„å¤„ç†

### 3. å…¼å®¹æ€§æµ‹è¯•
- [ ] æµ‹è¯•æ–°ç”¨æˆ·æ³¨å†Œæµç¨‹
- [ ] æµ‹è¯•è€ç”¨æˆ·ç™»å½•æµç¨‹
- [ ] æµ‹è¯•å¤šç§Ÿæˆ·åœºæ™¯

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. å°ç¨‹åºç™»å½•é™åˆ¶
- æ— æ³•è·å–ç”¨æˆ·è¯¦ç»†èµ„æ–™ï¼ˆæ˜µç§°ã€å¤´åƒç­‰ï¼‰
- åªèƒ½è·å–openidå’Œsession_key
- éœ€è¦ç”¨æˆ·ä¸»åŠ¨æˆæƒæ‰èƒ½è·å–æ›´å¤šä¿¡æ¯

### 2. å®‰å…¨æ€§è€ƒè™‘
- session_keyä¸åº”è¯¥å­˜å‚¨åˆ°æ•°æ®åº“
- å®šæœŸåˆ·æ–°token
- éªŒè¯openidçš„æœ‰æ•ˆæ€§

### 3. ç”¨æˆ·ä½“éªŒ
- æä¾›é»˜è®¤æ˜µç§°å’Œå¤´åƒ
- å…è®¸ç”¨æˆ·åç»­å®Œå–„ä¸ªäººä¿¡æ¯
- ä¿æŒç™»å½•çŠ¶æ€æŒä¹…åŒ–

## ğŸš€ åç»­ä¼˜åŒ–

### 1. åŠŸèƒ½å®Œå–„
- [ ] æ·»åŠ ç”¨æˆ·ä¿¡æ¯å®Œå–„åŠŸèƒ½
- [ ] å®ç°å¤´åƒä¸Šä¼ 
- [ ] æ·»åŠ æ‰‹æœºå·ç»‘å®š
- [ ] å®ç°å¾®ä¿¡æ”¯ä»˜åŠŸèƒ½

### 2. æ€§èƒ½ä¼˜åŒ–
- [ ] æ·»åŠ ç™»å½•ç¼“å­˜
- [ ] ä¼˜åŒ–tokenåˆ·æ–°æœºåˆ¶
- [ ] å®ç°ç¦»çº¿ç™»å½•

### 3. å®‰å…¨å¢å¼º
- [ ] æ·»åŠ ç™»å½•é¢‘ç‡é™åˆ¶
- [ ] å®ç°è®¾å¤‡ç»‘å®š
- [ ] æ·»åŠ å¼‚å¸¸ç™»å½•æ£€æµ‹

---

*ä¿®å¤å®Œæˆæ—¶é—´: 2024å¹´*
*ç‰ˆæœ¬: v1.0*
*çŠ¶æ€: å·²ä¿®å¤*
