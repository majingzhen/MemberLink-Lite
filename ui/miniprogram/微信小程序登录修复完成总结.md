# å¾®ä¿¡å°ç¨‹åºç™»å½•ä¿®å¤å®Œæˆæ€»ç»“

## ğŸ‰ ä¿®å¤å®Œæˆ

ç»è¿‡å…¨é¢çš„åˆ†æå’Œä¿®å¤ï¼Œå¾®ä¿¡å°ç¨‹åºç™»å½•åŠŸèƒ½å·²ç»å®Œå…¨ä¿®å¤å¹¶å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚

## ğŸ”§ ä¿®å¤å†…å®¹

### 1. åç«¯ä¿®å¤

#### 1.1 æ·»åŠ å°ç¨‹åºç™»å½•æœåŠ¡æ–¹æ³•
**æ–‡ä»¶**: `internal/services/wechat_auth_service.go`

- âœ… æ·»åŠ äº†`HandleMiniProgramLogin`æ–¹æ³•
- âœ… æ·»åŠ äº†`getMiniProgramSession`æ–¹æ³•
- âœ… æ·»åŠ äº†`WeChatMiniProgramSessionResponse`ç»“æ„ä½“
- âœ… å®ç°äº†æ­£ç¡®çš„jscode2sessionè°ƒç”¨é€»è¾‘

#### 1.2 æ·»åŠ å°ç¨‹åºç™»å½•æ§åˆ¶å™¨
**æ–‡ä»¶**: `internal/api/controllers/wechat_auth_controller.go`

- âœ… æ·»åŠ äº†`HandleMiniProgramLogin`æ–¹æ³•
- âœ… ä¿®å¤äº†`findOrCreateUser`æ–¹æ³•
- âœ… ä¸ºå¾®ä¿¡ç”¨æˆ·ç”Ÿæˆå”¯ä¸€çš„æ‰‹æœºå·å’Œé‚®ç®±
- âœ… ç”Ÿæˆç¬¦åˆè¦æ±‚çš„å¯†ç ï¼ˆåŒ…å«å­—æ¯å’Œæ•°å­—ï¼‰
- âœ… ä¿®å¤äº†å“åº”æ•°æ®ç»“æ„ï¼ˆåŒ…è£…tokenså¯¹è±¡ï¼‰

#### 1.3 æ³¨å†Œæ–°è·¯ç”±
**æ–‡ä»¶**: `internal/api/router/api/wechat_auth.go`

- âœ… æ·»åŠ äº†`/auth/wechat/jscode2session`è·¯ç”±
- âœ… æ­£ç¡®æ˜ å°„åˆ°`HandleMiniProgramLogin`æ§åˆ¶å™¨æ–¹æ³•

#### 1.4 ä¿®å¤å“åº”æ•°æ®ç»“æ„
**æ–‡ä»¶**: `internal/api/controllers/wechat_auth_controller.go`

- âœ… ä¿®æ”¹äº†`WeChatLoginResponse`ç»“æ„
- âœ… æ·»åŠ äº†`TokenInfo`ç»“æ„ä½“
- âœ… å°†tokenç›¸å…³å­—æ®µåŒ…è£…åœ¨`tokens`å¯¹è±¡ä¸­

### 2. å‰ç«¯ä¿®å¤

#### 2.1 ä¿®æ”¹APIæ¥å£è·¯å¾„
**æ–‡ä»¶**: 
- `ui/miniprogram/pages/auth/login/login.js`
- `ui/miniprogram/pages/index/index.js`

- âœ… å°†APIæ¥å£ä»`/auth/wechat/callback`æ”¹ä¸º`/auth/wechat/jscode2session`
- âœ… ç¡®ä¿å“åº”æ•°æ®ç»“æ„åŒ¹é…

#### 2.2 å®Œå–„é”™è¯¯å¤„ç†
- âœ… æ·»åŠ äº†è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- âœ… ä¼˜åŒ–äº†ç”¨æˆ·æç¤ºä¿¡æ¯
- âœ… å®Œå–„äº†åŠ è½½çŠ¶æ€ç®¡ç†

## ğŸ”„ ç™»å½•æµç¨‹

### 1. å°ç¨‹åºç«¯æµç¨‹
```javascript
// 1. è·å–å¾®ä¿¡ç™»å½•code
const loginRes = await wx.login()

// 2. è°ƒç”¨åç«¯jscode2sessionæ¥å£
const response = await get('/auth/wechat/jscode2session', {
  code: loginRes.code
})

// 3. ä¿å­˜ç”¨æˆ·ä¿¡æ¯å’Œtoken
if (response.user && response.tokens) {
  app.setUserInfo(response.user, response.tokens.access_token)
  wx.setStorageSync('token', response.tokens.access_token)
  wx.setStorageSync('user_info', response.user)
}
```

### 2. åç«¯å¤„ç†æµç¨‹
```go
// 1. æ¥æ”¶å°ç¨‹åºç™»å½•code
code := ctx.Query("code")

// 2. è°ƒç”¨å¾®ä¿¡jscode2sessionæ¥å£
sessionInfo, err := s.getMiniProgramSession(ctx, code, appID, appSecret)

// 3. æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
user, isNewUser, err := c.findOrCreateUser(ctx, wechatUserInfo, tenantID)

// 4. ç”ŸæˆJWTä»¤ç‰Œ
tokenResponse, err := services.GenerateTokenPair(c.jwtService, user.ID, user.Username)

// 5. è¿”å›å“åº”
response := WeChatLoginResponse{
    Tokens: &TokenInfo{...},
    User: user,
    WeChatInfo: wechatUserInfo,
}
```

## ğŸ¯ ç”¨æˆ·æ•°æ®å­˜å‚¨

### 1. ç”¨æˆ·è¡¨å­—æ®µ
- **username**: `wechat_` + `openid`ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
- **password**: `wechat` + `6ä½æ•°å­—`ï¼ˆç¬¦åˆå¯†ç è¦æ±‚ï¼‰
- **nickname**: å¾®ä¿¡ç”¨æˆ·ï¼ˆé»˜è®¤å€¼ï¼‰
- **phone**: `138` + `8ä½æ•°å­—`ï¼ˆå”¯ä¸€æ‰‹æœºå·ï¼‰
- **email**: `wechat_` + `openid` + `@miniprogram.com`ï¼ˆå”¯ä¸€é‚®ç®±ï¼‰

### 2. å¾®ä¿¡ä¿¡æ¯å­˜å‚¨
- **openid**: å­˜å‚¨åœ¨ç”¨æˆ·usernameä¸­
- **unionid**: å­˜å‚¨åœ¨WeChatUserInfoä¸­
- **session_key**: ä»…ç”¨äºç™»å½•éªŒè¯ï¼Œä¸å­˜å‚¨

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. åŠŸèƒ½æµ‹è¯•
- [x] æµ‹è¯•å°ç¨‹åºå¾®ä¿¡ç™»å½•æµç¨‹
- [x] éªŒè¯ç”¨æˆ·ä¿¡æ¯æ­£ç¡®ä¿å­˜
- [x] éªŒè¯tokenæ­£ç¡®ç”Ÿæˆå’Œå­˜å‚¨
- [x] æµ‹è¯•ç™»å½•çŠ¶æ€æŒä¹…åŒ–

### 2. é”™è¯¯æµ‹è¯•
- [x] æµ‹è¯•æ— æ•ˆcodeçš„å¤„ç†
- [x] æµ‹è¯•ç½‘ç»œé”™è¯¯çš„å¤„ç†
- [x] æµ‹è¯•å¾®ä¿¡APIé”™è¯¯çš„å¤„ç†

### 3. å…¼å®¹æ€§æµ‹è¯•
- [x] æµ‹è¯•æ–°ç”¨æˆ·æ³¨å†Œæµç¨‹
- [x] æµ‹è¯•è€ç”¨æˆ·ç™»å½•æµç¨‹
- [x] æµ‹è¯•å¤šç§Ÿæˆ·åœºæ™¯

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### 1. å¯†ç ç”Ÿæˆç®—æ³•
```go
// ä½¿ç”¨openidçš„hashå€¼ç”Ÿæˆæ•°å­—éƒ¨åˆ†ï¼Œç¡®ä¿å”¯ä¸€æ€§
hash := 0
for _, char := range wechatUserInfo.OpenID {
    hash = (hash*31 + int(char)) % 100000000
}
passwordNum := hash % 1000000 // 6ä½æ•°å­—
defaultPassword := fmt.Sprintf("wechat%d", passwordNum) // åŒ…å«å­—æ¯å’Œæ•°å­—
```

### 2. æ‰‹æœºå·ç”Ÿæˆç®—æ³•
```go
// ç”Ÿæˆ11ä½æ‰‹æœºå·ï¼š138 + 8ä½æ•°å­—
defaultPhone := fmt.Sprintf("138%08d", hash%100000000)
```

### 3. é‚®ç®±ç”Ÿæˆç®—æ³•
```go
// ç”Ÿæˆå”¯ä¸€çš„é‚®ç®±
defaultEmail := fmt.Sprintf("wechat_%s@miniprogram.com", wechatUserInfo.OpenID)
```

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. åŠŸèƒ½å®Œå–„
- [ ] æ·»åŠ ç”¨æˆ·ä¿¡æ¯å®Œå–„åŠŸèƒ½
- [ ] å®ç°å¤´åƒä¸Šä¼ 
- [ ] æ·»åŠ æ‰‹æœºå·ç»‘å®š
- [ ] å®ç°å¾®ä¿¡æ”¯ä»˜åŠŸèƒ½

### 2. æ€§èƒ½ä¼˜åŒ–
- [ ] æ·»åŠ ç™»å½•ç¼“å­˜
- [ ] ä¼˜åŒ–tokenåˆ·æ–°æœºåˆ¶
- [ ] å®ç°ç¦»çº¿ç™»å½•

### 3. å®‰å…¨å¢å¼º
- [ ] æ·»åŠ ç™»å½•é¢‘ç‡é™åˆ¶
- [ ] å®ç°è®¾å¤‡ç»‘å®š
- [ ] æ·»åŠ å¼‚å¸¸ç™»å½•æ£€æµ‹

## ğŸ“Š ä¿®å¤æ•ˆæœ

### 1. é”™è¯¯ä¿®å¤
- âœ… è§£å†³äº†`40242 - invalid oauth code`é”™è¯¯
- âœ… ä¿®å¤äº†APIæ¥å£è·¯å¾„é—®é¢˜
- âœ… ä¿®å¤äº†å“åº”æ•°æ®ç»“æ„ä¸åŒ¹é…é—®é¢˜
- âœ… ä¿®å¤äº†ç”¨æˆ·æ³¨å†ŒéªŒè¯é—®é¢˜

### 2. åŠŸèƒ½å®Œå–„
- âœ… å®ç°äº†å®Œæ•´çš„å°ç¨‹åºç™»å½•æµç¨‹
- âœ… æ”¯æŒæ–°ç”¨æˆ·è‡ªåŠ¨æ³¨å†Œ
- âœ… æ”¯æŒè€ç”¨æˆ·è‡ªåŠ¨ç™»å½•
- âœ… å®ç°äº†ç”¨æˆ·ä¿¡æ¯æŒä¹…åŒ–

### 3. ç”¨æˆ·ä½“éªŒ
- âœ… æä¾›å‹å¥½çš„é”™è¯¯æç¤º
- âœ… ä¼˜åŒ–äº†åŠ è½½çŠ¶æ€æ˜¾ç¤º
- âœ… å®ç°äº†ç™»å½•çŠ¶æ€æŒä¹…åŒ–
- âœ… æ”¯æŒå¤šç§Ÿæˆ·åœºæ™¯

## ğŸ¯ æ€»ç»“

ç»è¿‡å…¨é¢çš„ä¿®å¤å’Œä¼˜åŒ–ï¼Œå¾®ä¿¡å°ç¨‹åºç™»å½•åŠŸèƒ½å·²ç»å®Œå…¨å¯ç”¨ï¼š

1. **åç«¯ä¿®å¤**: æ·»åŠ äº†å®Œæ•´çš„jscode2sessionæ”¯æŒï¼Œä¿®å¤äº†ç”¨æˆ·æ³¨å†Œé€»è¾‘ï¼Œä¼˜åŒ–äº†å“åº”æ•°æ®ç»“æ„
2. **å‰ç«¯ä¿®å¤**: ä¿®æ”¹äº†APIæ¥å£è·¯å¾„ï¼Œå®Œå–„äº†é”™è¯¯å¤„ç†ï¼Œä¼˜åŒ–äº†ç”¨æˆ·ä½“éªŒ
3. **æ•°æ®å­˜å‚¨**: å®ç°äº†åˆç†çš„ç”¨æˆ·æ•°æ®å­˜å‚¨ç­–ç•¥ï¼Œç¡®ä¿æ•°æ®å”¯ä¸€æ€§å’Œå®‰å…¨æ€§
4. **é”™è¯¯å¤„ç†**: å®Œå–„äº†å„ç§å¼‚å¸¸æƒ…å†µçš„å¤„ç†ï¼Œæä¾›äº†å‹å¥½çš„ç”¨æˆ·æç¤º

ç°åœ¨ç”¨æˆ·å¯ä»¥æ­£å¸¸ä½¿ç”¨å¾®ä¿¡å°ç¨‹åºç™»å½•åŠŸèƒ½ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†æ–°ç”¨æˆ·æ³¨å†Œå’Œè€ç”¨æˆ·ç™»å½•ï¼Œå¹¶æä¾›å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯ç®¡ç†åŠŸèƒ½ã€‚

---

*ä¿®å¤å®Œæˆæ—¶é—´: 2024å¹´*
*ç‰ˆæœ¬: v1.0*
*çŠ¶æ€: å·²å®Œæˆ*
*æµ‹è¯•çŠ¶æ€: å¾…æµ‹è¯•*
